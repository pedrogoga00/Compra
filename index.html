<script>
        // --- VARIABLES GLOBALES Y UTILIDADES ---
        const PANTRY_KEY = 'miDespensa_items';
        const ZONES_KEY = 'miDespensa_zones';
        const HISTORY_KEY = 'miDespensa_history';
        // Zonas por defecto para empezar (incluye las que has mencionado)
        const INITIAL_DEFAULT_ZONES = ['Nevera', 'Armario', 'Congelador', 'Especieros', 'Baño']; 
        
        let allItems = [];
        let allZones = [];
        let history = [];

        // Referencias a elementos del DOM
        const pantryListEl = document.getElementById('pantry-list');
        const shoppingListEl = document.getElementById('shopping-list');
        const historyListEl = document.getElementById('history-list');
        const userIdDisplayEl = document.getElementById('user-id-display');
        const modalEl = document.getElementById('message-modal');
        const modalTitleEl = document.getElementById('modal-title');
        const modalBodyEl = document.getElementById('modal-body');
        const archiveButton = document.getElementById('archive-button');
        const zonesListEl = document.getElementById('zones-list');
        
        // --- LÓGICA DE LOCAL STORAGE (Base de Datos Local) ---

        /** Carga los items, zonas e historial desde localStorage */
        function loadAllFromLocalStorage() {
            try {
                allItems = JSON.parse(localStorage.getItem(PANTRY_KEY) || '[]');
                const savedZones = JSON.parse(localStorage.getItem(ZONES_KEY) || '[]');
                history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
                
                // Si no hay zonas guardadas, inicializa con las por defecto.
                if (savedZones.length === 0) {
                    allZones = [...INITIAL_DEFAULT_ZONES].sort();
                    saveZones(); 
                } else {
                    // Si ya hay zonas, las carga y las ordena.
                    allZones = savedZones.sort();
                }

                // Renderiza la interfaz inicial
                renderAddZoneSelect();
                renderItems(allItems);
                renderShoppingList();
                renderHistory();

            } catch (e) {
                console.error("Error al cargar datos de localStorage:", e);
                showModal("Error Crítico", "No se pudieron cargar los datos guardados en tu navegador.", 'error');
            }
        }

        /** Guarda los items en localStorage */
        function saveItems() {
            localStorage.setItem(PANTRY_KEY, JSON.stringify(allItems));
            renderItems(allItems);
            renderShoppingList();
        }

        /** Guarda las zonas en localStorage */
        function saveZones() {
            localStorage.setItem(ZONES_KEY, JSON.stringify(allZones));
            renderAddZoneSelect();
            renderZoneManagementModal();
        }

        /** Guarda el historial en localStorage */
        function saveHistory() {
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
            renderHistory();
        }

        // --- LÓGICA DE GESTIÓN DE ZONAS (REEMPLAZANDO FIREBASE) ---

        window.addCustomZone = function() {
            const newZoneName = document.getElementById('new-zone-input').value.trim();
            if (!newZoneName) return;

            // Evitar duplicados
            if (allZones.map(z => z.toLowerCase()).includes(newZoneName.toLowerCase())) {
                showModal("Error", `La zona "${newZoneName}" ya existe.`, 'error');
                return;
            }

            allZones.push(newZoneName);
            allZones.sort(); // Reordenar
            saveZones();
            document.getElementById('new-zone-input').value = '';
            showModal("Éxito", `Zona "${newZoneName}" añadida.`, 'success');
        };

        window.deleteCustomZone = function(zoneToDelete) {
            const initialLength = allZones.length;
            
            // Advertencia para zonas por defecto
            if (INITIAL_DEFAULT_ZONES.includes(zoneToDelete)) {
                if (!confirm(`"${zoneToDelete}" es una zona predeterminada. ¿Estás seguro de que quieres eliminarla? Los productos se moverán a 'Otros'.`)) {
                    return;
                }
            }
            
            allZones = allZones.filter(z => z !== zoneToDelete);
            
            if (allZones.length < initialLength) {
                // Mover productos de la zona eliminada a 'Otros'
                allItems.forEach(item => {
                    if (item.zone === zoneToDelete) {
                        item.zone = 'Otros'; 
                    }
                });
                saveItems();
                saveZones();
                showModal("Éxito", `Zona "${zoneToDelete}" eliminada. Los productos se movieron a "Otros".`, 'success');
            } else {
                // Esto solo debería ocurrir si se intenta eliminar una zona que no existe, lo cual es raro
                showModal("Error", "No se pudo eliminar la zona.", 'error');
            }
        };

        function renderZoneManagementModal() {
            zonesListEl.innerHTML = '';

            if (allZones.length === 0) {
                zonesListEl.innerHTML = '<p class="text-center text-gray-500 p-4">¡No hay zonas! Añade tu primera zona arriba.</p>';
                return;
            }

            allZones.forEach(zone => {
                const isDefault = INITIAL_DEFAULT_ZONES.includes(zone);
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-3 rounded-lg bg-gray-50 border border-gray-200';
                
                li.innerHTML = `
                    <span class="text-gray-800">${zone}</span>
                    <div>
                        ${isDefault ? 
                            '<span class="text-xs text-gray-500 mr-2">Predeterminado</span>' : ''
                        }
                        <button onclick="deleteCustomZone('${zone.replace(/'/g, "\\'")}')" class="p-1 rounded-full bg-red-100 text-red-600 hover:bg-red-200 transition duration-150" title="Eliminar Zona">
                            <svg class="icon w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 7h16M10 11v6m4 -6v6M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3"/></svg>
                        </button>
                    </div>
                `;
                zonesListEl.appendChild(li);
            });
        }

        function renderAddZoneSelect() {
            const selectEl = document.getElementById('product-zone');
            selectEl.innerHTML = '';
            
            // Si la lista de zonas está vacía (muy improbable con la carga inicial), al menos ponemos "Otros"
            if (allZones.length === 0) {
                 allZones = ['Otros']; 
            }
            
            allZones.forEach(zone => {
                const option = document.createElement('option');
                option.value = zone;
                option.textContent = zone;
                selectEl.appendChild(option);
            });
             
            // Asegurarse de que "Otros" está presente si no fue añadido previamente.
            if (!allZones.includes('Otros')) {
                const optionOther = document.createElement('option');
                optionOther.value = 'Otros';
                optionOther.textContent = 'Otros';
                selectEl.appendChild(optionOther);
            }
        }
        
        // --- LÓGICA DE PRODUCTOS (ITEMS) (ADAPTADA A LOCAL STORAGE) ---

        /** Genera un ID único (reemplaza el ID de Firestore) */
        function generateId() {
            // Genera un ID único simple basado en el tiempo y un número aleatorio
            return Date.now().toString(36) + Math.random().toString(36).substring(2);
        }

        /** Renderiza la lista completa de productos agrupados por zona (Pestaña Despensa) */
        function renderItems(items) {
            pantryListEl.innerHTML = '';
            // No limpiar shoppingListEl aquí, se hace en renderShoppingList()

            if (items.length === 0) {
                pantryListEl.innerHTML = '<p class="text-center text-gray-500 p-8 border-2 border-dashed border-gray-200 rounded-lg">¡Tu despensa está vacía! Añade algunos productos arriba.</p>';
                renderShoppingList(); // Asegurar que también se limpia la lista de la compra
                return;
            }

            // 1. Renderizar Pestaña Despensa (Inventario Completo)
            const groups = items.reduce((acc, item) => {
                // Usar 'Otros' si la zona no existe en la lista actual de zonas
                const zone = item.zone && allZones.includes(item.zone) ? item.zone :
